{
  "version": 3,
  "sources": ["../src/shared/config.ts", "../src/shared/llm.ts", "../src/shared/messages.ts", "../src/background/index.ts"],
  "sourcesContent": ["export type ExtensionConfig = {\n  apiBaseUrl: string;\n  apiKey: string;\n  model: string;\n  systemPrompt: string;\n};\n\nconst SYNC_KEY = 'promptEnhancerConfig';\nconst LOCAL_KEY = 'promptEnhancerSecrets';\n\nexport const DEFAULT_CONFIG: ExtensionConfig = {\n  apiBaseUrl: 'https://api.openai.com/v1',\n  apiKey: '',\n  model: 'gpt-4.1-mini',\n  systemPrompt:\n    'You upgrade user prompts into concise, structured prompts with clear inputs, outputs, and constraints. Return only the improved prompt.'\n};\n\ntype StorageArea = 'sync' | 'local';\n\nfunction readFromStorage<T>(area: StorageArea, key: string): Promise<T | undefined> {\n  return new Promise((resolve) => {\n    const storageArea = chrome?.storage?.[area];\n    if (!storageArea) {\n      resolve(undefined);\n      return;\n    }\n    storageArea.get(key, (result: Record<string, T>) => resolve(result?.[key]));\n  });\n}\n\nfunction writeToStorage<T>(area: StorageArea, key: string, value: T): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const storageArea = chrome?.storage?.[area];\n    if (!storageArea) {\n      resolve();\n      return;\n    }\n    storageArea.set({ [key]: value }, () => {\n      const lastError = chrome.runtime?.lastError;\n      if (lastError) {\n        reject(lastError);\n      } else {\n        resolve();\n      }\n    });\n  });\n}\n\nexport async function loadConfig(): Promise<ExtensionConfig> {\n  const [syncConfig, localSecrets] = await Promise.all([\n    readFromStorage<ExtensionConfig>('sync', SYNC_KEY),\n    readFromStorage<{ apiKey: string }>('local', LOCAL_KEY)\n  ]);\n\n  return {\n    ...DEFAULT_CONFIG,\n    ...syncConfig,\n    apiKey: localSecrets?.apiKey ?? syncConfig?.apiKey ?? ''\n  };\n}\n\nexport async function saveConfig(next: ExtensionConfig): Promise<void> {\n  const { apiKey, ...rest } = next;\n  await Promise.all([\n    writeToStorage('sync', SYNC_KEY, rest),\n    writeToStorage('local', LOCAL_KEY, { apiKey })\n  ]);\n}\n\nexport function normalizeApiBase(url: string): string {\n  const trimmed = url.trim();\n  if (!trimmed) return DEFAULT_CONFIG.apiBaseUrl;\n  return trimmed.endsWith('/') ? trimmed.slice(0, -1) : trimmed;\n}\n", "import { ExtensionConfig, normalizeApiBase } from './config';\n\ntype ChatCompletionChoice = { message?: { content?: string } };\ntype ChatCompletionResponse = { choices?: ChatCompletionChoice[] };\n\nexport async function requestOptimizedPrompt(\n  config: ExtensionConfig,\n  originalPrompt: string,\n  pageHost?: string\n): Promise<string> {\n  if (!originalPrompt.trim()) {\n    throw new Error('Prompt is empty');\n  }\n  if (!config.apiKey) {\n    throw new Error('API key is missing');\n  }\n\n  const endpoint = `${normalizeApiBase(config.apiBaseUrl)}/chat/completions`;\n  const systemPrompt = config.systemPrompt || '';\n  const userContent = buildUserContent(originalPrompt, pageHost);\n\n  const response = await fetch(endpoint, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${config.apiKey}`\n    },\n    body: JSON.stringify({\n      model: config.model,\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: userContent }\n      ]\n    })\n  });\n\n  if (!response.ok) {\n    const text = await response.text().catch(() => '');\n    throw new Error(`Model request failed (${response.status}): ${text || 'unknown error'}`);\n  }\n\n  const data = (await response.json()) as ChatCompletionResponse;\n  const optimized = data?.choices?.[0]?.message?.content?.trim();\n  if (!optimized) {\n    throw new Error('Model returned no content');\n  }\n  return optimized;\n}\n\nfunction buildUserContent(originalPrompt: string, pageHost?: string): string {\n  const hostLine = pageHost ? `Target host: ${pageHost}\\n` : '';\n  return `${hostLine}Optimize the following prompt. Return only the improved prompt:\\n\\n${originalPrompt}`;\n}\n", "export const MessageType = {\n  OptimizePrompt: 'OPTIMIZE_PROMPT'\n} as const;\n\nexport type MessageKind = typeof MessageType[keyof typeof MessageType];\n\nexport type OptimizePromptRequest = {\n  type: typeof MessageType.OptimizePrompt;\n  payload: {\n    originalPrompt: string;\n    styleId?: string;\n    source?: 'content-script' | 'popup';\n    pageHost?: string;\n  };\n};\n\nexport type OptimizePromptResponse = {\n  success: boolean;\n  optimizedPrompt?: string;\n  error?: string;\n};\n\nexport function isOptimizePromptRequest(message: unknown): message is OptimizePromptRequest {\n  if (!message || typeof message !== 'object') return false;\n  const typed = message as OptimizePromptRequest;\n  return typed.type === MessageType.OptimizePrompt && Boolean(typed.payload?.originalPrompt);\n}\n", "import { loadConfig } from '../shared/config';\nimport { requestOptimizedPrompt } from '../shared/llm';\nimport { isOptimizePromptRequest, OptimizePromptResponse } from '../shared/messages';\n\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  if (!isOptimizePromptRequest(message)) return;\n\n  handleOptimize(message)\n    .then((response) => sendResponse(response))\n    .catch((error: Error) =>\n      sendResponse({\n        success: false,\n        error: error?.message || 'Unknown error'\n      } satisfies OptimizePromptResponse)\n    );\n\n  return true; // keep the message channel open for async responses\n});\n\nasync function handleOptimize(message: Parameters<typeof isOptimizePromptRequest>[0]): Promise<OptimizePromptResponse> {\n  const config = await loadConfig();\n  if (!config.apiKey) {\n    return { success: false, error: '\u8BF7\u5148\u5728 Options \u9875\u9762\u914D\u7F6E API Key' };\n  }\n  const optimizedPrompt = await requestOptimizedPrompt(config, message.payload.originalPrompt, message.payload.pageHost);\n  return { success: true, optimizedPrompt };\n}\n"],
  "mappings": ";AAOA,IAAM,WAAW;AACjB,IAAM,YAAY;AAEX,IAAM,iBAAkC;AAAA,EAC7C,YAAY;AAAA,EACZ,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,cACE;AACJ;AAIA,SAAS,gBAAmB,MAAmB,KAAqC;AAClF,SAAO,IAAI,QAAQ,CAAC,YAAY;AAC9B,UAAM,cAAc,QAAQ,UAAU,IAAI;AAC1C,QAAI,CAAC,aAAa;AAChB,cAAQ,MAAS;AACjB;AAAA,IACF;AACA,gBAAY,IAAI,KAAK,CAAC,WAA8B,QAAQ,SAAS,GAAG,CAAC,CAAC;AAAA,EAC5E,CAAC;AACH;AAoBA,eAAsB,aAAuC;AAC3D,QAAM,CAAC,YAAY,YAAY,IAAI,MAAM,QAAQ,IAAI;AAAA,IACnD,gBAAiC,QAAQ,QAAQ;AAAA,IACjD,gBAAoC,SAAS,SAAS;AAAA,EACxD,CAAC;AAED,SAAO;AAAA,IACL,GAAG;AAAA,IACH,GAAG;AAAA,IACH,QAAQ,cAAc,UAAU,YAAY,UAAU;AAAA,EACxD;AACF;AAUO,SAAS,iBAAiB,KAAqB;AACpD,QAAM,UAAU,IAAI,KAAK;AACzB,MAAI,CAAC,QAAS,QAAO,eAAe;AACpC,SAAO,QAAQ,SAAS,GAAG,IAAI,QAAQ,MAAM,GAAG,EAAE,IAAI;AACxD;;;ACrEA,eAAsB,uBACpB,QACA,gBACA,UACiB;AACjB,MAAI,CAAC,eAAe,KAAK,GAAG;AAC1B,UAAM,IAAI,MAAM,iBAAiB;AAAA,EACnC;AACA,MAAI,CAAC,OAAO,QAAQ;AAClB,UAAM,IAAI,MAAM,oBAAoB;AAAA,EACtC;AAEA,QAAM,WAAW,GAAG,iBAAiB,OAAO,UAAU,CAAC;AACvD,QAAM,eAAe,OAAO,gBAAgB;AAC5C,QAAM,cAAc,iBAAiB,gBAAgB,QAAQ;AAE7D,QAAM,WAAW,MAAM,MAAM,UAAU;AAAA,IACrC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,eAAe,UAAU,OAAO,MAAM;AAAA,IACxC;AAAA,IACA,MAAM,KAAK,UAAU;AAAA,MACnB,OAAO,OAAO;AAAA,MACd,UAAU;AAAA,QACR,EAAE,MAAM,UAAU,SAAS,aAAa;AAAA,QACxC,EAAE,MAAM,QAAQ,SAAS,YAAY;AAAA,MACvC;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,OAAO,MAAM,SAAS,KAAK,EAAE,MAAM,MAAM,EAAE;AACjD,UAAM,IAAI,MAAM,yBAAyB,SAAS,MAAM,MAAM,QAAQ,eAAe,EAAE;AAAA,EACzF;AAEA,QAAM,OAAQ,MAAM,SAAS,KAAK;AAClC,QAAM,YAAY,MAAM,UAAU,CAAC,GAAG,SAAS,SAAS,KAAK;AAC7D,MAAI,CAAC,WAAW;AACd,UAAM,IAAI,MAAM,2BAA2B;AAAA,EAC7C;AACA,SAAO;AACT;AAEA,SAAS,iBAAiB,gBAAwB,UAA2B;AAC3E,QAAM,WAAW,WAAW,gBAAgB,QAAQ;AAAA,IAAO;AAC3D,SAAO,GAAG,QAAQ;AAAA;AAAA,EAAsE,cAAc;AACxG;;;ACpDO,IAAM,cAAc;AAAA,EACzB,gBAAgB;AAClB;AAoBO,SAAS,wBAAwB,SAAoD;AAC1F,MAAI,CAAC,WAAW,OAAO,YAAY,SAAU,QAAO;AACpD,QAAM,QAAQ;AACd,SAAO,MAAM,SAAS,YAAY,kBAAkB,QAAQ,MAAM,SAAS,cAAc;AAC3F;;;ACtBA,OAAO,QAAQ,UAAU,YAAY,CAAC,SAAS,SAAS,iBAAiB;AACvE,MAAI,CAAC,wBAAwB,OAAO,EAAG;AAEvC,iBAAe,OAAO,EACnB,KAAK,CAAC,aAAa,aAAa,QAAQ,CAAC,EACzC;AAAA,IAAM,CAAC,UACN,aAAa;AAAA,MACX,SAAS;AAAA,MACT,OAAO,OAAO,WAAW;AAAA,IAC3B,CAAkC;AAAA,EACpC;AAEF,SAAO;AACT,CAAC;AAED,eAAe,eAAe,SAAyF;AACrH,QAAM,SAAS,MAAM,WAAW;AAChC,MAAI,CAAC,OAAO,QAAQ;AAClB,WAAO,EAAE,SAAS,OAAO,OAAO,8DAA2B;AAAA,EAC7D;AACA,QAAM,kBAAkB,MAAM,uBAAuB,QAAQ,QAAQ,QAAQ,gBAAgB,QAAQ,QAAQ,QAAQ;AACrH,SAAO,EAAE,SAAS,MAAM,gBAAgB;AAC1C;",
  "names": []
}
